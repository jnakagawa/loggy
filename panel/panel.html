<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics Logger</title>
  <link rel="stylesheet" href="panel.css">
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <div class="header-left">
        <img src="../loggy.png" alt="Loggy Logo" class="header-logo">
        <h1>Analytics Logger</h1>
      </div>
      <div class="header-actions">
        <button id="pauseBtn" class="btn btn-secondary" title="Pause event collection">
          ‚è∏Ô∏è Pause
        </button>
        <button id="settingsBtn" class="btn btn-secondary" title="Settings">
          ‚öôÔ∏è
        </button>
      </div>
    </header>

    <!-- Stats Bar -->
    <div class="stats-bar">
      <div class="stat">
        <span class="stat-label">Total Events:</span>
        <span class="stat-value" id="totalEvents">0</span>
      </div>
      <div class="stat">
        <span class="stat-label">Filtered:</span>
        <span class="stat-value" id="filteredEvents">0</span>
      </div>
      <div class="stat">
        <span class="stat-label">Storage:</span>
        <span class="stat-value" id="storageUsage">0%</span>
      </div>
      <div class="stat proxy-stat">
        <span class="stat-label">Proxy:</span>
        <span class="stat-value" id="proxyStatusMain">Checking...</span>
        <button id="proxyActionBtn" class="btn btn-primary btn-small">Start</button>
        <span class="info-icon" title="Enable the proxy to capture events from other Chrome extensions.">i</span>
      </div>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
      <input
        type="text"
        id="searchInput"
        class="search-input"
        placeholder="Search events, properties, URLs..."
      >
      <select id="sourceFilter" class="filter-select">
        <option value="">All Sources</option>
        <!-- Sources will be populated dynamically -->
      </select>
      <select id="eventTypeFilter" class="filter-select">
        <option value="">All Events</option>
      </select>
      <button id="clearFiltersBtn" class="btn btn-secondary btn-small">Clear Filters</button>
    </div>

    <!-- Action Bar -->
    <div class="action-bar">
      <div id="pendingNotification" class="pending-indicator" style="display: none;">
        <span class="pending-indicator-icon">üí°</span>
        <span class="pending-indicator-text"><strong id="pendingCount">0</strong> new source(s)</span>
        <button id="viewPendingBtn" class="btn btn-small">View</button>
      </div>
      <div class="action-bar-spacer"></div>
      <button id="clearBtn" class="btn btn-danger btn-small">Clear All</button>
      <button id="exportJSONBtn" class="btn btn-primary btn-small">Export JSON</button>
      <button id="exportCSVBtn" class="btn btn-primary btn-small">Export CSV</button>
    </div>

    <!-- Events List -->
    <div class="events-container">
      <div id="emptyState" class="empty-state">
        <div class="empty-icon">üì≠</div>
        <h2>No events captured yet</h2>
        <p>Analytics events will appear here automatically as your extensions send them.</p>
        <p class="empty-hint">Try using an extension that sends analytics events (e.g., Segment, Google Analytics).</p>
      </div>
      <div id="eventsList" class="events-list"></div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal" style="display: none;">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Settings</h2>
          <button id="closeSettingsBtn" class="btn-close">‚úï</button>
        </div>

        <!-- Settings Tabs -->
        <div class="modal-tabs">
          <button class="tab-btn active" data-tab="general">General</button>
          <button class="tab-btn" data-tab="sources">Sources</button>
        </div>

        <div class="modal-body">
          <!-- General Settings Tab -->
          <div id="generalTab" class="tab-content active">
          <div class="setting-group">
            <label class="setting-label">
              <input type="checkbox" id="persistSetting">
              <span>Persist Events (save to storage)</span>
            </label>
          </div>

          <div class="setting-group">
            <label class="setting-label">
              Max Events (Ring Buffer Size):
            </label>
            <input type="number" id="maxEventsSetting" min="100" max="10000" step="100" value="1000">
          </div>

          <div class="setting-group">
            <label class="setting-label">
              Auto-Pause After Inactivity:
            </label>
            <select id="autoPauseHoursSetting" class="filter-select">
              <option value="1">1 hour</option>
              <option value="2">2 hours</option>
              <option value="3" selected>3 hours (default)</option>
              <option value="24">24 hours</option>
              <option value="0">Disabled</option>
            </select>
            <small style="color: #666; font-size: 11px; margin-top: 4px; display: block;">
              Automatically pause event capture after no events are received for this duration.
            </small>
          </div>

          <div class="setting-group">
            <label class="setting-label checkbox-label">
              <input type="checkbox" id="detectNewSourcesSetting" checked>
              <span>Detect New Sources</span>
            </label>
            <small style="color: #666; font-size: 11px; margin-top: 4px; display: block;">
              Automatically detect and suggest new analytics sources from unmatched requests.
            </small>
          </div>

          </div><!-- End General Tab -->

          <!-- Sources Tab -->
          <div id="sourcesTab" class="tab-content">
            <!-- Pending Sources Section -->
            <div id="pendingSourcesSection" class="pending-sources-section" style="display: none;">
              <div class="pending-sources-header">
                <h4>Pending Sources</h4>
                <span class="pending-sources-hint">These analytics endpoints were detected but don't match any configured source.</span>
              </div>
              <div id="pendingSourcesList" class="pending-sources-list">
                <!-- Pending sources will be populated here -->
              </div>
            </div>

            <div class="sources-header">
              <h3>Analytics Sources</h3>
              <div style="display: flex; gap: 8px;">
                <button id="addSourceBtn" class="btn btn-primary btn-small">+ Add Source</button>
                <button id="importSourcesBtn" class="btn btn-secondary btn-small">Import</button>
                <button id="exportSourcesBtn" class="btn btn-secondary btn-small">Export</button>
              </div>
            </div>

            <div id="sourcesList" class="sources-list">
              <!-- Sources will be populated here -->
            </div>
          </div><!-- End Sources Tab -->

        </div><!-- End modal-body -->
        <div class="modal-footer">
          <button id="saveSettingsBtn" class="btn btn-primary">Save Settings</button>
          <button id="cancelSettingsBtn" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Source Editor Modal -->
  <div id="sourceEditorModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="sourceEditorTitle">Edit Source</h2>
        <button id="closeSourceEditorBtn" class="btn-close">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="source-enabled-toggle">
          <label class="toggle-label">
            <input type="checkbox" id="sourceEnabled" checked>
            <span class="toggle-switch"></span>
            <span class="toggle-text">Enabled</span>
          </label>
        </div>

        <div class="setting-group">
          <label class="setting-label">Name</label>
          <input type="text" id="sourceName" placeholder="e.g., Honey, My App">
        </div>

        <div class="setting-group">
          <label class="setting-label">Domain</label>
          <input type="text" id="sourceDomain" placeholder="e.g., joinhoney.com">
          <small style="color: #666; font-size: 11px;">Base domain to match (matches all subdomains automatically)</small>
        </div>

        <div class="setting-group">
          <label class="setting-label">Color</label>
          <input type="color" id="sourceColor" value="#6366F1">
        </div>

        <div class="setting-group field-overrides">
          <label class="setting-label">Field Mappings</label>
          <small style="color: #666; font-size: 11px; display: block; margin-bottom: 8px;">
            Click to select which payload field maps to each value. Leave empty for auto-detection.
          </small>
          <div class="field-pickers">
            <div class="field-picker-row">
              <label class="field-picker-label">Event Name:</label>
              <div class="field-picker" id="fieldPickerEventName" data-field="eventName">
                <span class="field-picker-value">auto-detect</span>
                <span class="field-picker-arrow"></span>
              </div>
              <input type="hidden" id="fieldEventName">
            </div>
            <div class="field-picker-row">
              <label class="field-picker-label">Timestamp:</label>
              <div class="field-picker" id="fieldPickerTimestamp" data-field="timestamp">
                <span class="field-picker-value">auto-detect</span>
                <span class="field-picker-arrow"></span>
              </div>
              <input type="hidden" id="fieldTimestamp">
            </div>
            <div class="field-picker-row">
              <label class="field-picker-label">User ID:</label>
              <div class="field-picker" id="fieldPickerUserId" data-field="userId">
                <span class="field-picker-value">auto-detect</span>
                <span class="field-picker-arrow"></span>
              </div>
              <input type="hidden" id="fieldUserId">
            </div>
          </div>
          <!-- Field options dropdown (populated dynamically) -->
          <div id="fieldOptionsDropdown" class="field-options-dropdown" style="display: none;">
            <div class="field-options-list"></div>
          </div>
        </div>

        <div class="setting-group" id="sourceStats" style="display: none;">
          <label class="setting-label">Statistics</label>
          <div style="font-size: 13px; color: #666;">
            <div>Events Captured: <span id="statsEventsCapture">0</span></div>
            <div>Last Captured: <span id="statsLastCaptured">Never</span></div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="deleteSourceBtn" class="btn btn-danger" style="margin-right: auto;">Delete</button>
        <button id="saveSourceBtn" class="btn btn-primary">Save</button>
        <button id="cancelSourceBtn" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Confirm Modal -->
  <div id="confirmModal" class="modal" style="display: none;">
    <div class="modal-content confirm-modal-content">
      <div class="modal-header">
        <h2 id="confirmTitle">Confirm</h2>
      </div>
      <div class="modal-body">
        <p id="confirmMessage">Are you sure?</p>
        <label class="setting-label" id="confirmDontAskLabel" style="margin-top: 16px;">
          <input type="checkbox" id="confirmDontAsk">
          <span>Don't ask me again</span>
        </label>
      </div>
      <div class="modal-footer">
        <button id="confirmCancelBtn" class="btn btn-secondary">Cancel</button>
        <button id="confirmOkBtn" class="btn btn-primary">OK</button>
      </div>
    </div>
  </div>

  <script type="module" src="panel.js"></script>
</body>
</html>
